<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Chiffreur de fichiers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --bg-panel: #0f172a;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.15);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #f97373;
      --radius: 14px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 900px;
      background: linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      border-radius: 24px;
      box-shadow:
        0 24px 80px rgba(15,23,42,0.9),
        0 0 0 1px rgba(148,163,184,0.15);
      padding: 20px 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    @media (min-width: 720px) {
      .app {
        padding: 26px 28px 30px;
        gap: 22px;
      }
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    h1 {
      font-size: 1.4rem;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text-soft);
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--text-soft);
      max-width: 520px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 720px) {
      .grid {
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
        gap: 18px;
      }
    }

    .panel {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(129,140,248,0.12), transparent 55%),
                  var(--bg-panel);
      border-radius: var(--radius);
      padding: 14px 14px 16px;
      border: 1px solid rgba(148,163,184,0.25);
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    @media (min-width: 720px) {
      .panel {
        padding: 16px 16px 18px;
      }
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(56,189,248,0.12), transparent 60%);
      opacity: 0.4;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .panel-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .dropzone {
      border-radius: 14px;
      border: 1px dashed rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.85);
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.18s ease, background 0.18s ease, transform 0.12s ease;
    }

    .dropzone:hover {
      border-color: var(--accent);
      background: rgba(15,23,42,0.95);
      transform: translateY(-1px);
    }

    .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(15,23,42,1);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
    }

    .drop-main {
      font-size: 0.9rem;
    }

    .drop-main span {
      color: var(--accent);
      font-weight: 500;
    }

    .drop-sub {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .file-input {
      display: none;
    }

    .file-info {
      font-size: 0.8rem;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .file-name {
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-size {
      opacity: 0.8;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field-label {
      font-size: 0.8rem;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .field-label span {
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      padding: 8px 12px;
      font-size: 0.85rem;
      outline: none;
      transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    .input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
      background: rgba(15,23,42,1);
    }

    .input::placeholder {
      color: rgba(148,163,184,0.8);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.18s ease, opacity 0.12s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: #0b1120;
      box-shadow:
        0 10px 30px rgba(56,189,248,0.45),
        0 0 0 1px rgba(15,23,42,0.9);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow:
        0 14px 40px rgba(56,189,248,0.55),
        0 0 0 1px rgba(15,23,42,0.9);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow:
        0 6px 18px rgba(56,189,248,0.4),
        0 0 0 1px rgba(15,23,42,0.9);
    }

    .btn-ghost {
      background: rgba(15,23,42,0.9);
      color: var(--text-soft);
      border: 1px solid rgba(148,163,184,0.5);
    }

    .btn-ghost:hover {
      background: rgba(15,23,42,1);
      color: var(--text);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .status {
      font-size: 0.78rem;
      color: var(--text-soft);
      min-height: 1.1em;
    }

    .status.error {
      color: var(--danger);
    }

    .status.success {
      color: #4ade80;
    }

    .progress-wrap {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      overflow: hidden;
      border: 1px solid rgba(30,64,175,0.8);
    }

    .progress-inner {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #38bdf8, #6366f1);
      transition: width 0.15s ease;
    }

    .progress-label {
      font-size: 0.75rem;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.7rem;
    }

    .chip {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text-soft);
    }

    .chip-accent {
      border-color: rgba(56,189,248,0.7);
      color: var(--accent);
      background: var(--accent-soft);
    }

    .meta {
      font-size: 0.78rem;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .meta-key {
      opacity: 0.8;
    }

    .meta-value {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
      color: #e0f2fe;
    }

    .footer {
      font-size: 0.72rem;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      border-top: 1px solid rgba(30,64,175,0.6);
      padding-top: 8px;
      margin-top: 4px;
    }

    .footer span {
      opacity: 0.9;
    }

    .footer strong {
      font-weight: 600;
      color: #e0f2fe;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="title-row">
        <h1>
          üîê Chiffreur de fichiers
          <span class="badge">Client‚Äëside ‚Ä¢ Aucune donn√©e envoy√©e</span>
        </h1>
      </div>
      <p class="subtitle">
        D√©pose un fichier, choisis un mot de passe, et r√©cup√®re une copie chiffr√©e. L‚Äôoriginal reste intact sur ton disque.
      </p>
    </header>

    <main class="grid">
      <!-- Colonne gauche : s√©lection + param√®tres -->
      <section class="panel">
        <div class="panel-inner">
          <div class="panel-title">Fichier &amp; mot de passe</div>

          <label class="dropzone" id="dropzone">
            <input type="file" id="fileInput" class="file-input" />
            <div class="drop-main">
              <span>Cliquer pour choisir</span> ou d√©poser un fichier ici
            </div>
            <div class="drop-sub">
              Tous types accept√©s (mp4, jpg, pdf, docx, zip, etc.)
            </div>
          </label>

          <div class="file-info" id="fileInfo" style="display:none;">
            <div class="file-name" id="fileName"></div>
            <div class="file-size" id="fileSize"></div>
          </div>

          <div class="field">
            <div class="field-label">
              Mot de passe
              <span>Utilis√© pour d√©river la cl√© de chiffrement</span>
            </div>
            <input
              type="password"
              id="passwordInput"
              class="input"
              placeholder="Choisis un mot de passe solide"
              autocomplete="new-password"
            />
          </div>

          <div class="actions">
            <button type="button" class="btn btn-ghost" id="clearBtn">
              R√©initialiser
            </button>
            <button type="button" class="btn btn-primary" id="encryptBtn">
              Chiffrer &amp; t√©l√©charger la copie
            </button>
          </div>

          <div class="status" id="status"></div>
        </div>
      </section>

      <!-- Colonne droite : progression + m√©tadonn√©es -->
      <section class="panel">
        <div class="panel-inner">
          <div class="panel-title">Progression &amp; d√©tails</div>

          <div class="progress-wrap">
            <div class="progress-bar">
              <div class="progress-inner" id="progressBar"></div>
            </div>
            <div class="progress-label">
              <span id="progressLabel">En attente‚Ä¶</span>
              <span id="progressPercent">0%</span>
            </div>
          </div>

          <div class="chip-row">
            <div class="chip chip-accent">AES‚ÄëGCM 256 bits</div>
            <div class="chip">Cl√© d√©riv√©e via PBKDF2</div>
            <div class="chip">Tout se passe dans ton navigateur</div>
          </div>

          <div class="meta">
            <div class="meta-row">
              <span class="meta-key">Nom de sortie</span>
              <span class="meta-value" id="metaOutputName">‚Äî</span>
            </div>
            <div class="meta-row">
              <span class="meta-key">Taille chiffr√©e</span>
              <span class="meta-value" id="metaOutputSize">‚Äî</span>
            </div>
            <div class="meta-row">
              <span class="meta-key">Sel &amp; IV</span>
              <span class="meta-value" id="metaSaltIv">‚Äî</span>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <span>Le fichier original n‚Äôest jamais modifi√©, seule une copie chiffr√©e est g√©n√©r√©e.</span>
      <span><strong>Tip :</strong> garde ton mot de passe, sans lui le fichier est perdu.</span>
    </footer>
  </div>

  <script>
    // --- Helpers UI ---
    const fileInput = document.getElementById("fileInput");
    const dropzone = document.getElementById("dropzone");
    const fileInfo = document.getElementById("fileInfo");
    const fileNameEl = document.getElementById("fileName");
    const fileSizeEl = document.getElementById("fileSize");
    const passwordInput = document.getElementById("passwordInput");
    const encryptBtn = document.getElementById("encryptBtn");
    const clearBtn = document.getElementById("clearBtn");
    const statusEl = document.getElementById("status");
    const progressBar = document.getElementById("progressBar");
    const progressLabel = document.getElementById("progressLabel");
    const progressPercent = document.getElementById("progressPercent");
    const metaOutputName = document.getElementById("metaOutputName");
    const metaOutputSize = document.getElementById("metaOutputSize");
    const metaSaltIv = document.getElementById("metaSaltIv");

    let selectedFile = null;

    function formatBytes(bytes) {
      if (bytes === 0) return "0 o";
      const k = 1024;
      const sizes = ["o", "Ko", "Mo", "Go", "To"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    function setStatus(message, type = "") {
      statusEl.textContent = message || "";
      statusEl.className = "status" + (type ? " " + type : "");
    }

    function setProgress(p, label) {
      const clamped = Math.max(0, Math.min(100, p));
      progressBar.style.width = clamped + "%";
      progressPercent.textContent = clamped.toFixed(0) + "%";
      if (label) progressLabel.textContent = label;
    }

    function resetUI(full = false) {
      if (full) {
        selectedFile = null;
        fileInput.value = "";
        fileInfo.style.display = "none";
        fileNameEl.textContent = "";
        fileSizeEl.textContent = "";
        passwordInput.value = "";
        metaOutputName.textContent = "‚Äî";
        metaOutputSize.textContent = "‚Äî";
        metaSaltIv.textContent = "‚Äî";
      }
      setStatus("");
      setProgress(0, "En attente‚Ä¶");
    }

    function handleFile(file) {
      if (!file) return;
      selectedFile = file;
      fileInfo.style.display = "flex";
      fileNameEl.textContent = file.name;
      fileSizeEl.textContent = formatBytes(file.size);
      setStatus("");
      setProgress(0, "Fichier pr√™t √† √™tre chiffr√©");
    }

    // --- Drag & drop ---
    dropzone.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      handleFile(file);
    });

    ["dragenter", "dragover"].forEach((eventName) => {
      dropzone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add("dragover");
      });
    });

    ["dragleave", "drop"].forEach((eventName) => {
      dropzone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove("dragover");
      });
    });

    dropzone.addEventListener("drop", (e) => {
      const dt = e.dataTransfer;
      const file = dt.files && dt.files[0];
      handleFile(file);
    });

    // --- Crypto helpers (Web Crypto) ---
    async function getKeyFromPassword(password, salt) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw",
        enc.encode(password),
        { name: "PBKDF2" },
        false,
        ["deriveKey"]
      );

      return crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt,
          iterations: 150000,
          hash: "SHA-256",
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    function concatBuffers(buffers) {
      let totalLength = 0;
      for (const b of buffers) totalLength += b.byteLength;
      const tmp = new Uint8Array(totalLength);
      let offset = 0;
      for (const b of buffers) {
        tmp.set(new Uint8Array(b), offset);
        offset += b.byteLength;
      }
      return tmp.buffer;
    }

    function toHex(arrBuf) {
      const bytes = new Uint8Array(arrBuf);
      return Array.from(bytes)
        .map((b) => b.toString(16).padStart(2, "0"))
        .join("");
    }

    // --- Encryption flow ---
    async function encryptFile(file, password) {
      setStatus("Lecture du fichier‚Ä¶");
      setProgress(10, "Lecture du fichier‚Ä¶");

      const arrayBuffer = await file.arrayBuffer();

      setStatus("Pr√©paration de la cl√©‚Ä¶");
      setProgress(30, "D√©rivation de la cl√©‚Ä¶");

      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await getKeyFromPassword(password, salt);

      setStatus("Chiffrement en cours‚Ä¶");
      setProgress(60, "Chiffrement du contenu‚Ä¶");

      const encrypted = await crypto.subtle.encrypt(
        {
          name: "AES-GCM",
          iv,
        },
        key,
        arrayBuffer
      );

      setStatus("Assemblage du fichier chiffr√©‚Ä¶");
      setProgress(85, "Assemblage des m√©tadonn√©es‚Ä¶");

      // Format : [16 octets de sel][12 octets d‚ÄôIV][donn√©es chiffr√©es]
      const finalBuffer = concatBuffers([salt.buffer, iv.buffer, encrypted]);

      setProgress(100, "Termin√©");
      setStatus("Chiffrement termin√©. T√©l√©chargement de la copie chiffr√©e.", "success");

      const outName = file.name + ".encrypted";
      const blob = new Blob([finalBuffer], { type: "application/octet-stream" });

      // Mise √† jour des m√©tadonn√©es affich√©es
      metaOutputName.textContent = outName;
      metaOutputSize.textContent = formatBytes(blob.size);
      metaSaltIv.textContent =
        "salt=" + toHex(salt) + " ‚Ä¢ iv=" + toHex(iv);

      // D√©clenchement du t√©l√©chargement
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = outName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // --- Events ---
    encryptBtn.addEventListener("click", async () => {
      if (!selectedFile) {
        setStatus("Choisis d‚Äôabord un fichier √† chiffrer.", "error");
        return;
      }
      const password = passwordInput.value.trim();
      if (!password) {
        setStatus("Entre un mot de passe pour chiffrer le fichier.", "error");
        return;
      }

      encryptBtn.disabled = true;
      clearBtn.disabled = true;
      setStatus("");
      setProgress(5, "Initialisation‚Ä¶");

      try {
        await encryptFile(selectedFile, password);
      } catch (err) {
        console.error(err);
        setStatus("Erreur pendant le chiffrement. (Mot de passe trop court ? Probl√®me navigateur ?)", "error");
        setProgress(0, "En attente‚Ä¶");
      } finally {
        encryptBtn.disabled = false;
        clearBtn.disabled = false;
      }
    });

    clearBtn.addEventListener("click", () => {
      resetUI(true);
    });

    // Init
    resetUI(true);
  </script>
</body>
</html>
